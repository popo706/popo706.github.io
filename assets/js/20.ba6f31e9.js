(window.webpackJsonp=window.webpackJsonp||[]).push([[20],{407:function(n,s,e){"use strict";e.r(s);var t=e(40),i=Object(t.a)({},function(){var n=this,s=n.$createElement,e=n._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":n.$parent.slotKey}},[e("blockquote",[e("p",[n._v("背景：业务需求需要按照月份统计用户的签到时间，业务代码 处理 太耗性能，采用 sql 进行 时间戳转换成 '%Y-%m' 格式字符串，进行分组统计，\n但是 服务器在 正零区，目标东八区，需要在 时间戳 转换成 字符串之前指定 对应的 时区")])]),n._v(" "),e("h4",{attrs:{id:"业务逻辑"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#业务逻辑","aria-hidden":"true"}},[n._v("#")]),n._v(" 业务逻辑")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('        @Transactional\n        public List<MonthSignedInfo> getSignInfo(Account account) {\n    \n            Long accountId = account.getId();\n            // 查询月份统计为原生sql,存在时间戳转换为字符串，故先要指定时区\n            signRecRepository.setTimeZone("+8:00");\n            List<SignRec> signRecs = signRecRepository.findMonthSignInfoByAccountId(accountId);\n         \n            if (CollectionUtils.isEmpty(signRecs)) {\n                return Collections.emptyList();\n            }\n    \n            List<MonthSignedInfo> monthSignedInfos = new ArrayList<>();\n            signRecs.forEach(signRec -> monthSignedInfos.add(new MonthSignedInfo(signRec.getSignInTime(), signRec.getDuration())));\n            return monthSignedInfos;\n        }\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br"),e("span",{staticClass:"line-number"},[n._v("7")]),e("br"),e("span",{staticClass:"line-number"},[n._v("8")]),e("br"),e("span",{staticClass:"line-number"},[n._v("9")]),e("br"),e("span",{staticClass:"line-number"},[n._v("10")]),e("br"),e("span",{staticClass:"line-number"},[n._v("11")]),e("br"),e("span",{staticClass:"line-number"},[n._v("12")]),e("br"),e("span",{staticClass:"line-number"},[n._v("13")]),e("br"),e("span",{staticClass:"line-number"},[n._v("14")]),e("br"),e("span",{staticClass:"line-number"},[n._v("15")]),e("br"),e("span",{staticClass:"line-number"},[n._v("16")]),e("br")])]),e("h4",{attrs:{id:"原生sql"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#原生sql","aria-hidden":"true"}},[n._v("#")]),n._v(" 原生sql")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('        /**\n         * 设置当前时区\n         */\n        @Modifying\n        @Query(value = "set time_zone = ?1", nativeQuery = true)\n        void setTimeZone(String stringTimeZone);\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br"),e("span",{staticClass:"line-number"},[n._v("6")]),e("br")])]),e("p",[n._v("set time_zone 为session级别，受 spring Transactional 控制")]),n._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[n._v('        @Query(value = "select id,createTime,lastModified,accountId,unix_timestamp(concat(monthTime, \'-01\'))*1000 AS signInTime,signedInAccountId,signOutTime,signedOutAccountId,duration,evaluation " +\n                "FROM (select id,createTime,lastModified,accountId,from_unixtime(if(signInTime,signInTime,signOutTime) / 1000, \'%Y-%m\') AS monthTime,signedInAccountId, " +\n                "signOutTime,signedOutAccountId, SUM(duration) AS duration,evaluation " +\n                "FROM sign_rec WHERE accountId = ?1 GROUP BY monthTime) temp ORDER BY monthTime DESC", nativeQuery = true)\n        List<SignRec> findMonthSignInfoByAccountId(Long accountId);\n')])]),n._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[n._v("1")]),e("br"),e("span",{staticClass:"line-number"},[n._v("2")]),e("br"),e("span",{staticClass:"line-number"},[n._v("3")]),e("br"),e("span",{staticClass:"line-number"},[n._v("4")]),e("br"),e("span",{staticClass:"line-number"},[n._v("5")]),e("br")])]),e("hr"),n._v(" "),e("p",[e("a",{attrs:{href:"https://popo706.cn/",target:"_blank",rel:"noopener noreferrer"}},[n._v("popo先生的博客"),e("OutboundLink")],1)]),n._v(" "),e("hr")])},[],!1,null,null,null);s.default=i.exports}}]);