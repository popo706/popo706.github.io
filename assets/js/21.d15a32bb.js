(window.webpackJsonp=window.webpackJsonp||[]).push([[21],{412:function(e,a,s){"use strict";s.r(a);var n=s(40),t=Object(n.a)({},function(){var e=this,a=e.$createElement,s=e._self._c||a;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("blockquote",[s("p",[e._v("背景：部门产品存在 文件夹树形结构的功能，但原来的设计 对于文件夹树的获取 需要遍历 进行IO 查询，存在性能瓶颈，探索非遍历方案获取树形结构，性能调优。")])]),e._v(" "),s("h4",{attrs:{id:"树结构如下："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#树结构如下：","aria-hidden":"true"}},[e._v("#")]),e._v(" 树结构如下：")]),e._v(" "),s("p",[s("img",{attrs:{src:"/images/tech/mysql/tree/folder_tree.png",alt:"测试数据树结构图",title:"测试数据树结构图"}})]),e._v(" "),s("blockquote",[s("p",[e._v("查询节点为 p,已知 p 节点id,探究 分别 查询 p 节点的 父节点，祖父节点，子节点，子孙节点的 复杂程度,\n以及节点移动（p移动到b 节点下面）、节点删除(删除p节点，p节点子节点跟进，为d的子节点)、节点新增（p节点添加子节点 w）")])]),e._v(" "),s("h4",{attrs:{id:"原设计方案（adjacency-list-邻接表）："}},[s("a",{staticClass:"header-anchor",attrs:{href:"#原设计方案（adjacency-list-邻接表）：","aria-hidden":"true"}},[e._v("#")]),e._v(" 原设计方案（Adjacency list 邻接表）：")]),e._v(" "),s("blockquote",[s("p",[e._v("每一条记录存parent_id")])]),e._v(" "),s("ol",[s("li",[e._v("表结构：")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("CREATE TABLE `folder` (\n  `id` int(11) NOT NULL AUTO_INCREMENT COMMENT '主键id，自增',\n  `folderName` varchar(100) NOT NULL COMMENT '文件名',\n  `parentId` int(11) NOT NULL COMMENT '父节点id',\n  PRIMARY KEY (`id`),\n  INDEX `idx_parent_id` (`parentId` ASC)\n) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT = '文件夹表';\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[e._v("测试数据")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("    INSERT INTO `folder` (id,folderName,parentId)VALUES (1,'a',0); \n    INSERT INTO `folder` (id,folderName,parentId)VALUES (2,'b',0);  \n    INSERT INTO `folder` (id,folderName,parentId)VALUES (3,'c',0);  \n    INSERT INTO `folder` (id,folderName,parentId)VALUES (4,'d',1);  \n    INSERT INTO `folder` (id,folderName,parentId)VALUES (5,'e',1);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (6,'f',1);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (7,'x',2);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (8,'y',2);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (9,'z',2);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (10,'p',4);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (11,'q',4);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (12,'r',4);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (13,'t',5);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (14,'u',10);\n    INSERT INTO `folder` (id,folderName,parentId)VALUES (15,'v',14);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[e._v("查询语句")])]),e._v(" "),s("ul",[s("li",[s("p",[e._v("p 节点的父节点\n"),s("pre",[e._v("select * from folder where id=(select parentId from folder where id=10);\n")])])]),e._v(" "),s("li",[s("p",[e._v("p 节点 祖父节点")])])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("DROP FUNCTION IF EXISTS `getParentList`;\nDELIMITER //\nCREATE FUNCTION `getParentList`(rootId varchar(100)) \nRETURNS varchar(1000) \nBEGIN \nDECLARE fid varchar(100) default ''; \nDECLARE str varchar(1000) default rootId; \nWHILE rootId is not null  do \n\tSET fid =(SELECT parentId FROM folder WHERE id = rootId); \n\tIF fid is not null THEN \n\t\tSET str = concat(str, ',', fid); \n\t\tSET rootId = fid; \n\tELSE \n\t\tSET rootId = fid; \n\tEND IF; \nEND WHILE; \nreturn str;\nEND  //\nDELIMITER ;\nselect * from folder where FIND_IN_SET(id,getParentList(10)) \n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br")])]),s("ul",[s("li",[s("p",[e._v("p 节点 子节点\n"),s("pre",[e._v("select * from folder where parentId=10;\n")])])]),e._v(" "),s("li",[s("p",[e._v("p 节点 子孙节点")])])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("  `DROP FUNCTION IF EXISTS `getChildList`;\n  DELIMITER //\n  CREATE FUNCTION `getChildList`(rootId INT)\n  RETURNS varchar(1000) READS SQL DATA\n  BEGIN\n    DECLARE sTemp VARCHAR(1000);\n    DECLARE sTempChd VARCHAR(1000);\n    SET sTemp = '$';\n    SET sTempChd =cast(rootId as CHAR);\n    WHILE sTempChd is not null DO\n      SET sTemp = concat(sTemp,',',sTempChd);\n      SELECT group_concat(id) INTO sTempChd FROM folder where FIND_IN_SET(parentId,sTempChd)>0;\n    END WHILE;\n    RETURN sTemp;\n  END  //\n  DELIMITER ;\n  select *from folder where find_in_set(id, getChildList(10));\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br")])]),s("ul",[s("li",[e._v("节点新增（p节点添加子节点 w）\n"),s("code",[e._v("INSERT INTO folder (folderName,parentId)VALUES ('w',10);")])]),e._v(" "),s("li",[e._v("节点移动（p移动到b 节点下面，p 节点子孙节点跟随）")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("UPDATE folder f, ( SELECT * FROM folder WHERE folderName = 'b' ) temp \nSET f.parentId = temp.id \nWHERE f.id = 10;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br")])]),s("ul",[s("li",[e._v("节点删除(删除p节点，p节点子节点 u 跟进，为d的子节点)")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("update folder f,(select * from folder where folderName='p') temp\nset f.parentId=temp.parentId\nwhere f.parentId=10;\ndelete from folder where id=10;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("ul",[s("li",[e._v("获取整棵树结构(需要知道 树 层级结构)")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("SELECT t1.folderName AS lev1, t2.folderName as lev2, t3.folderName as lev3, t4.folderName as lev4,t5.folderName as lev5\nFROM folder AS t1\nLEFT JOIN folder AS t2 ON t2.parentId = t1.id\nLEFT JOIN folder AS t3 ON t3.parentId = t2.id\nLEFT JOIN folder AS t4 ON t4.parentId = t3.id\nLEFT JOIN folder AS t5 ON t5.parentId = t4.id\nWHERE t1.folderName = 'a';\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("p",[s("img",{attrs:{src:"/images/tech/mysql/tree/adjacency_data.png",alt:"邻接表树数据图",title:"邻接表树数据图"}})]),e._v(" "),s("h4",{attrs:{id:"路径表（path-enumeration）"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#路径表（path-enumeration）","aria-hidden":"true"}},[e._v("#")]),e._v(" 路径表（Path Enumeration）")]),e._v(" "),s("blockquote",[s("p",[e._v("每一条记录存整个tree path经过的node枚举")])]),e._v(" "),s("ol",[s("li",[e._v("表结构：")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("CREATE TABLE `path_folder` (\n  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键id,自增',\n  `folderName` VARCHAR(100) NOT NULL COMMENT '文件夹名称',\n  `path` VARCHAR(200) NOT NULL COMMENT '路径',\n  `parentId` INT(11) NOT NULL DEFAULT 0 COMMENT '父节点id'\n  PRIMARY KEY (`id`))\nENGINE = InnoDB\nDEFAULT CHARSET = utf8mb4\nCOMMENT = '路径文件夹表';\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[e._v("测试数据")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (1,'a','/0',0); \n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (2,'b','/0',0);  \n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (3,'c','/0',0);  \n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (4,'d','/1',1);  \n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (5,'e','/1',1);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (6,'f','/1',1);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (7,'x','/2',2);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (8,'y','/2',2);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (9,'z','/2',2);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (10,'p','/1/4',4);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (11,'q','/1/4',4);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (12,'r','/1/4',4);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (13,'t','/1/5',5);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (14,'u','/1/4/10',10);\n    INSERT INTO `path_folder` (id,folderName,path,parentId)VALUES (15,'v','/1/4/10/14',14);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[e._v("查询语句")])]),e._v(" "),s("ul",[s("li",[e._v("p 节点的父节点\n"),s("pre",[e._v("select * from path_folder where id=(select parentId from path_folder where id=10);\n")])]),e._v(" "),s("li",[e._v("p 节点 祖父节点")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("  SELECT *\n  FROM path_folder\n  WHERE id IN (\n  \tSELECT substring_index(substring_index(t.path, '/', b.help_topic_id + 1), '/', -1)\n  \tFROM path_folder t\n  \t\tJOIN mysql.help_topic b ON b.help_topic_id < LENGTH(t.path) - LENGTH(REPLACE(t.path, '/', '')) + 1\n  \tWHERE id = 10\n  );\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("blockquote",[s("p",[s("a",{attrs:{href:"https://blog.csdn.net/u012009613/article/details/52770567",target:"_blank",rel:"noopener noreferrer"}},[e._v("字符串切割参考文章"),s("OutboundLink")],1)])]),e._v(" "),s("ul",[s("li",[e._v("p 节点 子节点")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("select * from path_folder where parentId=10;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br")])]),s("ul",[s("li",[e._v("p 节点 子孙节点")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("SELECT * FROM path_folder\nWHERE path LIKE '%/10%';\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br")])]),s("ul",[s("li",[e._v("节点新增（p节点添加子节点 w）")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("INSERT INTO path_folder (folderName, path, parentId)\nSELECT 'w', concat((\n\t\tSELECT path\n\t\tFROM path_folder\n\t\tWHERE id = 10\n\t), '/10'), 10;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br")])]),s("ul",[s("li",[e._v("节点移动（p移动到b 节点下面，p 节点子孙节点跟随）")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("UPDATE path_folder pf, (\n\t\tSELECT *\n\t\tFROM path_folder\n\t\tWHERE folderName = 'b'\n\t) b, (\n\t\tSELECT *\n\t\tFROM path_folder\n\t\tWHERE id = 10\n\t) p\nSET pf.path = replace(pf.path, p.path, concat(if(b.path = '/0', '', b.path), '/', b.id))\nWHERE pf.path LIKE concat('%', p.path, '/%')\n\tOR pf.id = 10;\n\tUPDATE path_folder f, ( SELECT * FROM path_folder WHERE folderName = 'b' ) temp \n    SET f.parentId = temp.id \n    WHERE f.id = 10;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br")])]),s("ul",[s("li",[e._v("节点删除(删除p节点，p节点子节点 u 跟进，为d的子节点)")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("update path_folder f,(select * from path_folder where folderName='p') temp\nset f.parentId=temp.parentId\nwhere f.parentId=10;\nupdate path_folder\nset path=replace(path,'/10','')\nwhere path like \"%/10%\";\ndelete from folder where id=10;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("h4",{attrs:{id:"嵌套集（nested-sets）"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#嵌套集（nested-sets）","aria-hidden":"true"}},[e._v("#")]),e._v(" 嵌套集（Nested Sets）")]),e._v(" "),s("blockquote",[s("p",[e._v("每一条记录存 nleft 和 nright\n此处不适合当前业务，故不展开讨论，附相关博客地址，有需求可自行参考\n"),s("br"),e._v(" "),s("a",{attrs:{href:"https://blog.csdn.net/MONKEY_D_MENG/article/details/6647488",target:"_blank",rel:"noopener noreferrer"}},[e._v("树形结构的数据库表Schema设计"),s("OutboundLink")],1),e._v(" "),s("br"),e._v(" "),s("a",{attrs:{href:"https://zhuanlan.zhihu.com/p/43896062",target:"_blank",rel:"noopener noreferrer"}},[e._v("基于左右值编码的树形数据库表结构设计"),s("OutboundLink")],1),e._v(" "),s("br"),e._v(" "),s("a",{attrs:{href:"https://www.hi-roy.com/2016/08/15/%E5%9C%A8MySQL%E4%B8%AD%E5%AD%98%E5%82%A8%E6%A0%91%E7%BB%93%E6%9E%84/",target:"_blank",rel:"noopener noreferrer"}},[e._v("在MySQL中存储树状结构"),s("OutboundLink")],1),e._v(" "),s("br")])]),e._v(" "),s("h4",{attrs:{id:"路径表（closure-table）"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#路径表（closure-table）","aria-hidden":"true"}},[e._v("#")]),e._v(" 路径表（Closure Table）")]),e._v(" "),s("blockquote",[s("p",[e._v("维护一个表，所有的tree path作为记录进行保存")])]),e._v(" "),s("ol",[s("li",[e._v("表结构")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("CREATE TABLE `closure_path` (\n  `id` INT(11) NOT NULL AUTO_INCREMENT COMMENT '主键id,自增',\n  `folderName` VARCHAR(100) NOT NULL COMMENT '文件夹名称',\n  PRIMARY KEY (`id`))\nENGINE = InnoDB\nDEFAULT CHARACTER SET = utf8mb4\nCOMMENT = '路径表';\n\n\nCREATE TABLE `closure_path_relation` (\n  `id` INT NOT NULL AUTO_INCREMENT COMMENT '主键id,自增',\n  `ancestor` INT(1) NOT NULL COMMENT '祖先id',\n  `descendant` INT(11) NOT NULL COMMENT '后裔',\n  `isLeaf` TINYINT(11) NOT NULL COMMENT '是否为叶子节点',\n  `depth` INT(6) NOT NULL DEFAULT 0 COMMENT '深度',\n  PRIMARY KEY (`id`))\nENGINE = InnoDB\nDEFAULT CHARACTER SET = utf8mb4\nCOMMENT = '路径关系表';\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br")])]),s("ol",{attrs:{start:"2"}},[s("li",[e._v("测试数据")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("    INSERT INTO `closure_path` (id,folderName)VALUES (1,'a'); \n    INSERT INTO `closure_path` (id,folderName)VALUES (2,'b');  \n    INSERT INTO `closure_path` (id,folderName)VALUES (3,'c');  \n    INSERT INTO `closure_path` (id,folderName)VALUES (4,'d');  \n    INSERT INTO `closure_path` (id,folderName)VALUES (5,'e');\n    INSERT INTO `closure_path` (id,folderName)VALUES (6,'f');\n    INSERT INTO `closure_path` (id,folderName)VALUES (7,'x');\n    INSERT INTO `closure_path` (id,folderName)VALUES (8,'y');\n    INSERT INTO `closure_path` (id,folderName)VALUES (9,'z');\n    INSERT INTO `closure_path` (id,folderName)VALUES (10,'p');\n    INSERT INTO `closure_path` (id,folderName)VALUES (11,'q');\n    INSERT INTO `closure_path` (id,folderName)VALUES (12,'r');\n    INSERT INTO `closure_path` (id,folderName)VALUES (13,'t');\n    INSERT INTO `closure_path` (id,folderName)VALUES (14,'u');\n    INSERT INTO `closure_path` (id,folderName)VALUES (15,'v');\n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,1,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (2,2,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (3,3,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (4,4,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (5,5,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (6,6,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (7,7,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (8,8,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (9,9,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (10,10,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (11,11,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (12,12,0,0);\n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (13,13,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (14,14,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (15,15,0,0); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,4,0,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,5,0,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,6,1,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,10,0,2); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,11,0,2); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,12,0,2); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,13,1,2); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,14,0,3); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (1,15,1,4); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (2,7,1,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (2,8,1,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (2,9,1,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (5,13,1,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (4,10,0,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (4,11,1,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (4,12,1,1);\n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (4,14,0,2); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (4,15,1,4);\n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (10,14,0,1); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (10,15,1,2); \n    INSERT INTO `closure_path_relation` (ancestor,descendant,isLeaf,depth)VALUES (14,15,1,1); \n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br"),s("span",{staticClass:"line-number"},[e._v("9")]),s("br"),s("span",{staticClass:"line-number"},[e._v("10")]),s("br"),s("span",{staticClass:"line-number"},[e._v("11")]),s("br"),s("span",{staticClass:"line-number"},[e._v("12")]),s("br"),s("span",{staticClass:"line-number"},[e._v("13")]),s("br"),s("span",{staticClass:"line-number"},[e._v("14")]),s("br"),s("span",{staticClass:"line-number"},[e._v("15")]),s("br"),s("span",{staticClass:"line-number"},[e._v("16")]),s("br"),s("span",{staticClass:"line-number"},[e._v("17")]),s("br"),s("span",{staticClass:"line-number"},[e._v("18")]),s("br"),s("span",{staticClass:"line-number"},[e._v("19")]),s("br"),s("span",{staticClass:"line-number"},[e._v("20")]),s("br"),s("span",{staticClass:"line-number"},[e._v("21")]),s("br"),s("span",{staticClass:"line-number"},[e._v("22")]),s("br"),s("span",{staticClass:"line-number"},[e._v("23")]),s("br"),s("span",{staticClass:"line-number"},[e._v("24")]),s("br"),s("span",{staticClass:"line-number"},[e._v("25")]),s("br"),s("span",{staticClass:"line-number"},[e._v("26")]),s("br"),s("span",{staticClass:"line-number"},[e._v("27")]),s("br"),s("span",{staticClass:"line-number"},[e._v("28")]),s("br"),s("span",{staticClass:"line-number"},[e._v("29")]),s("br"),s("span",{staticClass:"line-number"},[e._v("30")]),s("br"),s("span",{staticClass:"line-number"},[e._v("31")]),s("br"),s("span",{staticClass:"line-number"},[e._v("32")]),s("br"),s("span",{staticClass:"line-number"},[e._v("33")]),s("br"),s("span",{staticClass:"line-number"},[e._v("34")]),s("br"),s("span",{staticClass:"line-number"},[e._v("35")]),s("br"),s("span",{staticClass:"line-number"},[e._v("36")]),s("br"),s("span",{staticClass:"line-number"},[e._v("37")]),s("br"),s("span",{staticClass:"line-number"},[e._v("38")]),s("br"),s("span",{staticClass:"line-number"},[e._v("39")]),s("br"),s("span",{staticClass:"line-number"},[e._v("40")]),s("br"),s("span",{staticClass:"line-number"},[e._v("41")]),s("br"),s("span",{staticClass:"line-number"},[e._v("42")]),s("br"),s("span",{staticClass:"line-number"},[e._v("43")]),s("br"),s("span",{staticClass:"line-number"},[e._v("44")]),s("br"),s("span",{staticClass:"line-number"},[e._v("45")]),s("br"),s("span",{staticClass:"line-number"},[e._v("46")]),s("br"),s("span",{staticClass:"line-number"},[e._v("47")]),s("br"),s("span",{staticClass:"line-number"},[e._v("48")]),s("br"),s("span",{staticClass:"line-number"},[e._v("49")]),s("br"),s("span",{staticClass:"line-number"},[e._v("50")]),s("br"),s("span",{staticClass:"line-number"},[e._v("51")]),s("br")])]),s("ol",{attrs:{start:"3"}},[s("li",[e._v("查询语句")])]),e._v(" "),s("ul",[s("li",[e._v("p 节点的父节点")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("select * from closure_path\nwhere id in(\nselect ancestor from closure_path_relation\nwhere descendant=10 and depth=1);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("ul",[s("li",[e._v("p 节点 祖父节点")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("select * from closure_path\nwhere id in(\nselect ancestor from closure_path_relation\nwhere descendant=10 and depth!=0);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("ul",[s("li",[e._v("p 节点 子节点")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("select * from closure_path\nwhere id in(\nselect descendant from closure_path_relation\nwhere ancestor=10 and depth=1);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("ul",[s("li",[e._v("p 节点 子孙节点")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("select * from closure_path\nwhere id in(\nselect descendant from closure_path_relation\nwhere ancestor=10 and depth!=0);\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br")])]),s("ul",[s("li",[e._v("节点新增（p节点添加子节点 w）")])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("insert into closure_path(folderName) values('w');\ninsert into closure_path_relation(ancestor,descendant,isLeaf,depth)\nselect ancestor,(select id from closure_path where folderName ='w'),1,(depth+1) from closure_path_relation\nwhere descendant=10;\ninsert into closure_path_relation(ancestor,descendant,isLeaf,depth)\nselect id,id,1,0 from closure_path\nwhere folderName='w';\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br")])]),s("ul",[s("li",[s("p",[e._v("节点移动（p移动到b 节点下面,p 节点子孙节点跟随）\n// todo 待添加")])]),e._v(" "),s("li",[s("p",[e._v("节点删除(删除p节点，p节点子节点 u 跟进，为d的子节点)")])])]),e._v(" "),s("div",{staticClass:"language- line-numbers-mode"},[s("pre",{pre:!0,attrs:{class:"language-text"}},[s("code",[e._v("update closure_path_relation\nset depth=depth-1\nwhere descendant in(select descendant from (select descendant from closure_path_relation\nwhere ancestor=10)temp);\ndelete from closure_path_relation\nwhere descendant=10 or ancestor=10;\ndelete from closure_path\nwhere id=20;\n")])]),e._v(" "),s("div",{staticClass:"line-numbers-wrapper"},[s("span",{staticClass:"line-number"},[e._v("1")]),s("br"),s("span",{staticClass:"line-number"},[e._v("2")]),s("br"),s("span",{staticClass:"line-number"},[e._v("3")]),s("br"),s("span",{staticClass:"line-number"},[e._v("4")]),s("br"),s("span",{staticClass:"line-number"},[e._v("5")]),s("br"),s("span",{staticClass:"line-number"},[e._v("6")]),s("br"),s("span",{staticClass:"line-number"},[e._v("7")]),s("br"),s("span",{staticClass:"line-number"},[e._v("8")]),s("br")])]),s("h3",{attrs:{id:"advantage-disvantage"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#advantage-disvantage","aria-hidden":"true"}},[e._v("#")]),e._v(" advantage && disvantage")]),e._v(" "),s("p",[s("img",{attrs:{src:"/images/tech/mysql/tree/tree_ad_vs_dis.jpg",alt:"优缺点对比图",title:"优缺点对比图"}})]),e._v(" "),s("hr"),e._v(" "),s("p",[s("a",{attrs:{href:"https://popo706.cn/",target:"_blank",rel:"noopener noreferrer"}},[e._v("popo先生的博客"),s("OutboundLink")],1)]),e._v(" "),s("hr")])},[],!1,null,null,null);a.default=t.exports}}]);